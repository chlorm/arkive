#!/usr/bin/env sh
##       ________   ___       ___
##      /  _____/  /  /      /  /
##     /  /       /  /      /  /
##    /  /       /  /____  /  / _______  _______  ____  ____
##   /  /       /  ___  / /  / /  __  / /  ____/ /    \/    \
##  /  /_____  /  /  / / /  / /  /_/ / /  /     /  /\    /\  \
## /________/ /__/  /_/ /__/ /______/ /__/     /__/  \__/  \__\ TM
##
## Title: ARKhive
## Author: Cody Opel
## E-mail: codyopel(at)gmail.com
## Copyright (c) 2014 All Rights Reserved, http://www.chlorm.net
## License: The MIT License - http://opensource.org/licenses/MIT
## Comments:
##    Dependencies:
##      fdkaac
##      ffmpeg[encode,ffprobe,fdkaac,threads] >=2.3.x
##      mkvtoolnix[mkvextract,mkvmerge]
##      opus
##      VobSub2SRT
##      x265 >=1.3.x
##      Obviously: awk, bash, cat, dirname, grep, pwd, tail, rm
##    Legend:
##      () - option
##      [] - description
##      ## - comments [not to be uncommented]
##      <> - issue description
##      # -- commented variables

VERSION="3"

# ERROR: something went wrong and program will exit
# WARNING: something went wrong, but program will continue

# EXIT CODES
# 1 - Input error

# RETURN CODES
# 2 - Cpu detection error


################################################################################
################################### SETTINGS ###################################
################################################################################

  # ac3 and similar formats not supported due to channel count limitations
  audioFormat="aac" #(aac,flac,ogg,opus)
  audioChannelBitrate="48" #kbps
  audioSampleRate="44100" #(44100,48000,82000,96000,192000)
  audioBitsPerSample="16" #(8,16,24)
  audioChannelMaping="2.0" #(2.0,4.0,5.1-rear,7.1,auto)

  containerFormat="mkv" #(mkv,mp4)

  languageDefault="eng" # ISO xxxx

  chaptersInclude="auto" #(no,auto)

  subtitlesInclude="auto" #(no,auto)
  subtitlesForced="no" #(no,auto)
  subtitlesConvertToSrt="auto" #(no,auto)

  videoBitrate="500" #kbps
  videoFrameRate="23.976"
  videoResolution="auto" #(480p,720p,1080p,4k,auto)
  videoCropBlackbars="auto" #(no,auto)
  videoDeinterlace="auto" #(no.auto)

################################################################################
################################### ARKHIVE ####################################
################################################################################

  term_colors

  arkhive

  cpu_info

  input_file_details

  if [ "$hasChapters" = "true" ] && [ "$chaptersInclude" = "auto" ]; then
    chapter_stream_extractor
  fi

  if [ "$hasSubtitles" = "true" ] && [ "$subtitlesInclude" ]; then
    subtitle_stream_selector
    subtitle_stream_extractor
  fi

  if [ "subtitlesNotSrt" = "true" ] && [ "$subtitlesConvertToSrt" = "auto" ]; then
    subtitle_srt_converter
  fi

  audio_stream_selector

  audio_channel_mapper

  audio_encoder

  if [ "$videoCropBlackbars" = "true" ]; then
    black_bar_crop_detection
  fi

  if [ "$videoDeinterlace" = "auto" ]; then
    video_interlace_detection
  fi

  video_encoder

  muxer

  temp_file_cleanup